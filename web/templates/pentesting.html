{% extends "base.html" %}
{% block title %}Penetration Testing - {{ app_name|default('Security Intelligence') }}{% endblock %}
{% block extra_css %}
<style>
    .pentest-type-card { border-radius: 12px; padding: 16px; background: var(--card-bg); border: 1px solid rgba(0,200,83,0.15); cursor: pointer; transition: all 0.2s; }
    .pentest-type-card:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,200,83,0.15); }
    .pentest-type-card.active { border-color: var(--accent-color); box-shadow: 0 0 0 2px rgba(0,200,83,0.3); }
    .finding-card { padding: 14px 18px; border-radius: 10px; background: rgba(255,255,255,0.03); margin-bottom: 10px; border-left: 4px solid; }
    .finding-card.critical { border-left-color: #f44336; }
    .finding-card.high { border-left-color: #ff9800; }
    .finding-card.medium { border-left-color: #ffeb3b; }
    .finding-card.low { border-left-color: #4caf50; }
    .cvss-badge { display: inline-block; padding: 4px 10px; border-radius: 6px; font-weight: 700; font-size: 0.85rem; }
    .owasp-row { padding: 10px 14px; border-radius: 8px; background: rgba(255,255,255,0.03); margin-bottom: 6px; }
    .kill-chain-step { padding: 12px; border-radius: 8px; text-align: center; background: rgba(0,200,83,0.05); border: 1px solid rgba(0,200,83,0.15); }
    .kill-chain-step.exploited { background: rgba(244,67,54,0.1); border-color: rgba(244,67,54,0.3); }
    .engagement-stat { text-align: center; padding: 16px; }
</style>
{% endblock %}
{% block content %}
<div class="container py-4">
    <div class="d-flex justify-content-between align-items-start mb-4">
        <div>
            <h2 class="text-white"><i class="bi bi-crosshair me-2" style="color:var(--accent-color);"></i>Penetration Testing</h2>
            <p style="color:#8b949e;">Full-stack offensive security assessment and findings management</p>
        </div>
        <div class="d-flex gap-2">
            <button class="btn btn-primary btn-sm"><i class="bi bi-plus me-1"></i>New Engagement</button>
            <button class="btn btn-outline-light btn-sm" onclick="exportReport()"><i class="bi bi-file-earmark-pdf me-1"></i>Export Report</button>
        </div>
    </div>

    <!-- Engagement Overview -->
    <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0 text-white">Current Engagement: Q1 2025 Full-Stack Pentest</h5>
            <span class="badge bg-warning">In Progress</span>
        </div>
        <div class="card-body">
            <div class="row g-3">
                <div class="col"><div class="engagement-stat"><div class="stat-value">42</div><small style="color:#8b949e;">Total Findings</small></div></div>
                <div class="col"><div class="engagement-stat"><div style="font-size:2rem;font-weight:700;color:#f44336;">5</div><small style="color:#8b949e;">Critical</small></div></div>
                <div class="col"><div class="engagement-stat"><div style="font-size:2rem;font-weight:700;color:#ff9800;">12</div><small style="color:#8b949e;">High</small></div></div>
                <div class="col"><div class="engagement-stat"><div style="font-size:2rem;font-weight:700;color:#ffeb3b;">16</div><small style="color:#8b949e;">Medium</small></div></div>
                <div class="col"><div class="engagement-stat"><div style="font-size:2rem;font-weight:700;color:#4caf50;">9</div><small style="color:#8b949e;">Low</small></div></div>
                <div class="col"><div class="engagement-stat"><div style="font-size:2rem;font-weight:700;color:#1e88e5;">68%</div><small style="color:#8b949e;">Remediated</small></div></div>
            </div>
        </div>
    </div>

    <!-- Pentest Types -->
    <div class="row g-3 mb-4">
        {% for icon, name, count in [('bi-globe', 'Web App', 18), ('bi-phone', 'Mobile', 6), ('bi-cloud', 'Cloud', 8), ('bi-hdd-network', 'Network', 5), ('bi-code-slash', 'API', 3), ('bi-person-badge', 'Social Eng', 2)] %}
        <div class="col-md-2">
            <div class="pentest-type-card text-center {% if loop.first %}active{% endif %}">
                <i class="bi {{ icon }}" style="font-size:1.5rem;color:var(--accent-color);"></i>
                <div style="color:#e6edf3;font-size:0.9rem;margin-top:6px;">{{ name }}</div>
                <span class="badge bg-secondary">{{ count }}</span>
            </div>
        </div>
        {% endfor %}
    </div>

    <div class="row g-4">
        <!-- Findings List -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header"><h5 class="mb-0 text-white">Findings</h5></div>
                <div class="card-body" id="findingsList"></div>
            </div>

            <!-- OWASP Top 10 Coverage -->
            <div class="card mb-4">
                <div class="card-header"><h5 class="mb-0 text-white"><i class="bi bi-shield-exclamation me-2"></i>OWASP Top 10 Coverage</h5></div>
                <div class="card-body"><canvas id="owaspChart" height="250"></canvas></div>
            </div>

            <!-- Attack Kill Chain -->
            <div class="card">
                <div class="card-header"><h5 class="mb-0 text-white"><i class="bi bi-diagram-3 me-2"></i>Attack Kill Chain Progress</h5></div>
                <div class="card-body">
                    <div class="row g-2" id="killChain"></div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Severity Breakdown -->
            <div class="card mb-4">
                <div class="card-header"><h5 class="mb-0 text-white">Severity Breakdown</h5></div>
                <div class="card-body"><canvas id="severityChart" height="200"></canvas></div>
            </div>

            <!-- Remediation Tracker -->
            <div class="card mb-4">
                <div class="card-header"><h5 class="mb-0 text-white"><i class="bi bi-check2-all me-2"></i>Remediation Progress</h5></div>
                <div class="card-body" id="remediation"></div>
            </div>

            <!-- Threat Model -->
            <div class="card">
                <div class="card-header"><h5 class="mb-0 text-white"><i class="bi bi-lightning me-2"></i>STRIDE Threats</h5></div>
                <div class="card-body"><canvas id="strideChart" height="200"></canvas></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
{% block extra_js %}
<script>
const FINDINGS = [
    { id:'PT-001', title:'SQL Injection in User Search API', severity:'critical', cvss:9.8, category:'Injection', status:'open', affected:'api.example.com/v2/users', remediation:'Use parameterized queries' },
    { id:'PT-002', title:'Broken Authentication - JWT Token Not Expiring', severity:'critical', cvss:9.1, category:'Auth', status:'in_progress', affected:'auth.example.com', remediation:'Implement token expiration and refresh' },
    { id:'PT-003', title:'Server-Side Request Forgery (SSRF)', severity:'critical', cvss:8.6, category:'SSRF', status:'open', affected:'app.example.com/import', remediation:'Validate and whitelist URLs' },
    { id:'PT-004', title:'Insecure Direct Object Reference (IDOR)', severity:'high', cvss:7.5, category:'Access Control', status:'remediated', affected:'api.example.com/v2/documents', remediation:'Implement authorization checks' },
    { id:'PT-005', title:'Cross-Site Scripting (Stored XSS)', severity:'high', cvss:7.2, category:'XSS', status:'in_progress', affected:'app.example.com/comments', remediation:'Sanitize user input, use CSP' },
    { id:'PT-006', title:'Sensitive Data in Error Messages', severity:'medium', cvss:5.3, category:'Information Disclosure', status:'open', affected:'Multiple endpoints', remediation:'Implement generic error handling' },
    { id:'PT-007', title:'Missing Rate Limiting on Login', severity:'medium', cvss:5.1, category:'Brute Force', status:'remediated', affected:'auth.example.com/login', remediation:'Implement rate limiting and lockout' },
    { id:'PT-008', title:'Outdated TLS 1.1 Still Enabled', severity:'medium', cvss:4.8, category:'Cryptography', status:'open', affected:'*.example.com', remediation:'Disable TLS 1.0/1.1, enforce 1.2+' },
    { id:'PT-009', title:'Missing Security Headers', severity:'low', cvss:3.1, category:'Configuration', status:'remediated', affected:'All web endpoints', remediation:'Add X-Frame-Options, CSP, HSTS' },
    { id:'PT-010', title:'Verbose Server Banner', severity:'low', cvss:2.0, category:'Information Disclosure', status:'open', affected:'*.example.com', remediation:'Remove server version from headers' },
];

const OWASP_DATA = [
    { id:'A01', name:'Broken Access Control', findings: 6 },
    { id:'A02', name:'Cryptographic Failures', findings: 3 },
    { id:'A03', name:'Injection', findings: 4 },
    { id:'A04', name:'Insecure Design', findings: 2 },
    { id:'A05', name:'Security Misconfiguration', findings: 5 },
    { id:'A06', name:'Vulnerable Components', findings: 3 },
    { id:'A07', name:'Auth Failures', findings: 4 },
    { id:'A08', name:'Data Integrity Failures', findings: 1 },
    { id:'A09', name:'Logging Failures', findings: 2 },
    { id:'A10', name:'SSRF', findings: 2 },
];

const KILL_CHAIN = [
    { phase:'Reconnaissance', status:'completed', findings: 3 },
    { phase:'Weaponization', status:'completed', findings: 0 },
    { phase:'Delivery', status:'exploited', findings: 2 },
    { phase:'Exploitation', status:'exploited', findings: 5 },
    { phase:'Installation', status:'exploited', findings: 3 },
    { phase:'C2', status:'blocked', findings: 0 },
    { phase:'Actions', status:'blocked', findings: 0 },
];

// Findings list
document.getElementById('findingsList').innerHTML = FINDINGS.map(f => {
    const colors = { critical:'#f44336', high:'#ff9800', medium:'#ffeb3b', low:'#4caf50' };
    const statusBadge = f.status==='remediated'?'bg-success':f.status==='in_progress'?'bg-info':'bg-secondary';
    return `<div class="finding-card ${f.severity}">
        <div class="d-flex justify-content-between align-items-start mb-1">
            <div><strong style="color:#e6edf3;">${f.id}</strong> <span style="color:#c9d1d9;">${f.title}</span></div>
            <div class="d-flex gap-2">
                <span class="cvss-badge" style="background:${colors[f.severity]}22;color:${colors[f.severity]};">CVSS ${f.cvss}</span>
                <span class="badge ${statusBadge}">${f.status.replace('_',' ')}</span>
            </div>
        </div>
        <small style="color:#8b949e;">${f.category} &middot; ${f.affected}</small>
    </div>`;
}).join('');

// OWASP chart
new Chart(document.getElementById('owaspChart'), {
    type: 'bar',
    data: {
        labels: OWASP_DATA.map(o => o.id),
        datasets: [{ label:'Findings', data: OWASP_DATA.map(o => o.findings), backgroundColor: OWASP_DATA.map(o => o.findings >= 5 ? '#f44336' : o.findings >= 3 ? '#ff9800' : '#4caf50') }]
    },
    options: {
        responsive: true, indexAxis: 'y',
        scales: { x:{grid:{color:'rgba(255,255,255,0.1)'},ticks:{color:'#8b949e'}}, y:{grid:{color:'rgba(255,255,255,0.05)'},ticks:{color:'#8b949e'}} },
        plugins: { legend:{display:false}, tooltip:{ callbacks:{ title:(items) => OWASP_DATA[items[0].dataIndex].name } } }
    }
});

// Severity donut
new Chart(document.getElementById('severityChart'), {
    type: 'doughnut',
    data: {
        labels: ['Critical','High','Medium','Low'],
        datasets: [{ data: [5,12,16,9], backgroundColor: ['#f44336','#ff9800','#ffeb3b','#4caf50'] }]
    },
    options: { responsive: true, plugins: { legend:{position:'bottom',labels:{color:'#8b949e'}} } }
});

// Kill chain
document.getElementById('killChain').innerHTML = KILL_CHAIN.map(k => {
    const cls = k.status === 'exploited' ? 'exploited' : '';
    const icon = k.status === 'completed' ? 'bi-check-circle text-success' : k.status === 'exploited' ? 'bi-exclamation-triangle text-danger' : 'bi-shield-check text-info';
    return `<div class="col"><div class="kill-chain-step ${cls}"><i class="bi ${icon}" style="font-size:1.2rem;"></i><div style="color:#e6edf3;font-size:0.8rem;margin-top:4px;">${k.phase}</div><small style="color:#8b949e;">${k.findings} findings</small></div></div>`;
}).join('');

// Remediation tracker
const remStats = { total:42, remediated:28, in_progress:7, open:7 };
const remPct = Math.round(remStats.remediated / remStats.total * 100);
document.getElementById('remediation').innerHTML = `
    <div class="text-center mb-3"><div style="font-size:2.5rem;font-weight:700;color:#00c853;">${remPct}%</div><small style="color:#8b949e;">Overall Remediation</small></div>
    <div class="mb-2"><div class="d-flex justify-content-between"><small style="color:#8b949e;">Critical</small><small style="color:#f44336;">3/5 fixed</small></div><div class="progress" style="height:6px;background:rgba(255,255,255,0.1);"><div class="progress-bar bg-danger" style="width:60%"></div></div></div>
    <div class="mb-2"><div class="d-flex justify-content-between"><small style="color:#8b949e;">High</small><small style="color:#ff9800;">9/12 fixed</small></div><div class="progress" style="height:6px;background:rgba(255,255,255,0.1);"><div class="progress-bar bg-warning" style="width:75%"></div></div></div>
    <div class="mb-2"><div class="d-flex justify-content-between"><small style="color:#8b949e;">Medium</small><small style="color:#ffeb3b;">11/16 fixed</small></div><div class="progress" style="height:6px;background:rgba(255,255,255,0.1);"><div class="progress-bar" style="width:69%;background:#ffeb3b;"></div></div></div>
    <div class="mb-2"><div class="d-flex justify-content-between"><small style="color:#8b949e;">Low</small><small style="color:#4caf50;">5/9 fixed</small></div><div class="progress" style="height:6px;background:rgba(255,255,255,0.1);"><div class="progress-bar bg-success" style="width:56%"></div></div></div>
`;

// STRIDE radar
new Chart(document.getElementById('strideChart'), {
    type: 'radar',
    data: {
        labels: ['Spoofing','Tampering','Repudiation','Info Disclosure','DoS','Elevation'],
        datasets: [{ label:'Threat Level', data:[7,5,3,8,4,6], backgroundColor:'rgba(0,200,83,0.2)', borderColor:'#00c853', pointBackgroundColor:'#00c853' }]
    },
    options: {
        responsive: true,
        scales: { r:{grid:{color:'rgba(255,255,255,0.1)'},angleLines:{color:'rgba(255,255,255,0.1)'},ticks:{color:'#8b949e',backdropColor:'transparent'},pointLabels:{color:'#8b949e'}} },
        plugins: { legend:{display:false} }
    }
});

function exportReport() { alert('Generating Penetration Test Report...\n\nIncludes:\n- Executive Summary\n- Methodology (OWASP/PTES)\n- Detailed Findings\n- Risk Ratings (CVSS)\n- Remediation Roadmap\n- Evidence & Screenshots'); }
</script>
{% endblock %}